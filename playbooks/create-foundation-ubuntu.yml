---
# Playbook to create a foundation snapshot/AMI from ubuntu's source images
- name: Ubuntu Foundation Create
  hosts: localhost
  connection: local
  #user: ubuntu (assumed)
  sudo: True
  tags: foundation
  vars:
    ami_role: "foundation"
  vars_files:
    - vars/ami.yml
    - vars/system/Ubuntu.yml
    - vars/install/Ubuntu.yml
    - [ "vars/site.yml", "vars/site.defaults.yml" ]
  roles:
    - build_host
  tasks:
    - include: tasks/ec2_get_facts.yml
    - include: tasks/ec2_create_vol_and_attach.yml
      vars:
        ebs_size: '{{ ami_root_size }}'
        ebs_device_id: '{{ ami_device }}'
    - include: tasks/image_write_qcow_from_url.yml
      vars:
        image_url: '{{ distro_image_url }}'
        image_path: '{{ distro_image_path }}'
        image_device: '{{ ami_device }}'
    - include: tasks/filesystem-grow.yml
    - include: tasks/chroot_mount_and_setup.yml
      vars:
        chroot_mountpoint: '{{ image_mount }}'
        chroot_device: '{{ ami_device }}'
    - name: Register chroot target in ansible inventory
      add_host: hostname={{ image_mount }} groupname=chroots


- name: Ubuntu Foundation Provision
  hosts: chroots
  connection: chroot
  user: root
  sudo: True
  tags: foundation
  vars:
    ami_role: "foundation"
    image_build: True
  vars_files:
    - [ "vars/site.yml", "vars/site.defaults.yml" ]
  roles:
    - foundation

- name: Ubuntu Foundation Finalize
  hosts: localhost
  connection: local
  #user: ubuntu (assumed)
  sudo: True
  tags: foundation
  vars:
    ami_role: "foundation"
  vars_files:
    - vars/ami.yml
    - vars/system/Ubuntu.yml
    - vars/install/Ubuntu.yml
    - [ "vars/site.yml", "vars/site.defaults.yml" ]
  tasks:
    - include: tasks/ec2_get_facts.yml
    - include: tasks/chroot_clean_and_unmount.yml
      vars:
        chroot_mountpoint: '{{ image_mount }}'
    - include: tasks/ec2_detach_and_snapshot_vol.yml
      vars:
        # ebs_volume_id: (comes via stored fact)
        ebs_snap_desc: '{{ ami_description }}'
        ebs_tag_name: '{{ ami_name }}'
    - include: tasks/ec2_ami_find_aki_ubuntu.yml
    - include: tasks/ec2_ami_tag_ebs_pvm.yml
    - include: tasks/ec2_ami_tag_ebs_hvm.yml
    - include: tasks/report-foundation.yml


---
# chroot_mountpoint:	where to mount
# chroot_device:	device to mount

# Don't use ansible module 'mount', as this is a transient thing
- name: Creating mount point for EBS volume
  file:
    path: '{{ chroot_mountpoint }}'
    state: directory
    owner: root
    group: root
    mode: 0444

- name: Mount EBS volume for chroot
  command: 'mount {{ chroot_device }}1 {{ chroot_mountpoint }}'

- name: Mount /proc filesystem into chroot
  command: 'chroot {{ chroot_mountpoint }} mount -t proc none /proc'

- name: Mount (bind) /dev filesystem into chroot
  command: 'mount -o bind /dev {{ chroot_mountpoint }}/dev'

# Don't use copy action, just command cp on remote
- name: Remove resolv.conf (maybe link) from chroot environment
  command: 'rm -f {{ chroot_mountpoint }}/etc/resolv.conf'

- name: Add working resolv.conf to chroot environment
  command: 'cp /etc/resolv.conf {{ chroot_mountpoint }}/etc/resolv.conf'

# FIXME: file source... 
- name: Disable rc.d for rest of the process.
  copy:
    src: policy-rc.d
    dest: '{{ chroot_mountpoint }}/usr/sbin/policy-rc.d'
    owner: root
    group: root
    mode: 0755

